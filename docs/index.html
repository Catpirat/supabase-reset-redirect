<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Procesando reset password...</title>
    <script>
      window.onload = () => {
        try {
          // Los parámetros están en el HASH (#), no en searchParams (?)
          const hashParams = new URLSearchParams(window.location.hash.substring(1));
          
          const accessToken = hashParams.get("access_token");
          const refreshToken = hashParams.get("refresh_token");
          const type = hashParams.get("type");
          const expiresIn = hashParams.get("expires_in");
          
          console.log("Parámetros extraídos:", {
            accessToken: accessToken ? "✓" : "✗",
            refreshToken: refreshToken ? "✓" : "✗", 
            type,
            expiresIn
          });

          if (type === "recovery" && accessToken) {
            // Construir el deep link con TODOS los parámetros necesarios
            const deepLink = `caparazonemocional://reset-password#access_token=${accessToken}&refresh_token=${refreshToken}&type=${type}&expires_in=${expiresIn}`;
            
            // URL alternativa para Android App Links
            const androidLink = `https://catpirat.github.io/supabase-reset-redirect/android-handler?access_token=${encodeURIComponent(accessToken)}&refresh_token=${encodeURIComponent(refreshToken)}&type=${type}&expires_in=${expiresIn}`;
            
            document.body.innerHTML = `
              <h2>Redirigiendo a la app...</h2>
              <p>Si no se abre automáticamente, prueba estos métodos:</p>
              <p><button onclick="openApp()" style="background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 5px; font-size: 16px; margin: 5px;">Método 1: Deep Link</button></p>
              <p><button onclick="openAndroidLink()" style="background: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 5px; font-size: 16px; margin: 5px;">Método 2: Android Link</button></p>
              <p><a href="${deepLink}">Enlace directo</a></p>
              <br>
              <details>
                <summary>Debug info</summary>
                <p>Access Token: ${accessToken ? "✓ Presente" : "✗ Faltante"}</p>
                <p>Refresh Token: ${refreshToken ? "✓ Presente" : "✗ Faltante"}</p>
                <p>Type: ${type}</p>
                <p>Expires In: ${expiresIn}</p>
                <p>Deep Link: ${deepLink}</p>
                <p>Android Link: ${androidLink}</p>
              </details>
            `;
            
            // Función para abrir la app con deep link
            window.openApp = function() {
              window.location.href = deepLink;
            };
            
            // Función para abrir con Android App Link
            window.openAndroidLink = function() {
              window.location.href = androidLink;
            };
            
            // Intentar múltiples métodos de redirección
            setTimeout(() => {
              // Método 1: location.href
              window.location.href = deepLink;
            }, 500);
            
            setTimeout(() => {
              // Método 2: location.assign
              window.location.assign(deepLink);
            }, 1500);
            
            setTimeout(() => {
              // Método 3: crear un iframe oculto
              const iframe = document.createElement('iframe');
              iframe.style.display = 'none';
              iframe.src = deepLink;
              document.body.appendChild(iframe);
            }, 2500);
            
          } else {
            document.body.innerHTML = `
              <h2>Error: parámetros inválidos</h2>
              <p>Type: ${type || "faltante"}</p>
              <p>Access Token: ${accessToken ? "presente" : "faltante"}</p>
              <p>URL completa: ${window.location.href}</p>
            `;
          }
        } catch (err) {
          document.body.innerHTML = `
            <h2>Error procesando la redirección</h2>
            <p>${err}</p>
            <p>URL: ${window.location.href}</p>
          `;
        }
      };
    </script>
  </head>
  <body>
    <h2>Procesando redirección...</h2>
    <p>Si no pasa nada, abre la app manualmente.</p>
  </body>
</html>
